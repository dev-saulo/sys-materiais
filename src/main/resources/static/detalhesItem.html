<!DOCTYPE html>
<html lang="pt-br">
<head>
    <title>Detalhes do Item</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="css/styleDetalheItem.css">
</head>
<body>

<nav>
    <a href="cadastrarItem.html">Cadastrar Itens</a>
    <a href="solicitarMaterial.html">Solicitar Materiais</a>
    <a href="usuarios.html">Usuários</a>
    <a href="login.html">Sair</a>
</nav>

<div class="container">

    <h2>Editar Item</h2>

    <form id="editForm" name="editForm">

        <label for="codigoInput">Código</label>
        <input id="codigoInput" name="codigo" placeholder="Código" readonly />

        <label for="nomeInput">Nome</label>
        <input id="nomeInput" name="nome" placeholder="Nome" required />

        <label>Status</label>
        <div class="status-container">
            <span id="statusBadge" class="badge badge-ativo">Ativo</span>
            <label class="switch">
                <input type="checkbox" id="ativoInput" name="ativo">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Salvar Alterações</button>
            <button type="button" id="voltarBtn" class="btn-secondary">Voltar</button>
        </div>

    </form>

    <div id="mensagem" role="alert" aria-live="polite" style="margin-top: 15px; text-align: center; font-weight: bold;"></div>


</div>

<script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const msgBox = document.getElementById('mensagem');
    const statusBadge = document.getElementById('statusBadge');
    const ativoInput = document.getElementById('ativoInput');

    function showMessage(text, ok = false) {
        msgBox.textContent = text;
        msgBox.style.color = ok ? '#10b981' : '#ef4444';
        setTimeout(() => { msgBox.textContent = ''; }, 5000);
    }

    function atualizarBadge() {
        if (ativoInput.checked) {
            statusBadge.textContent = 'Ativo';
            statusBadge.className = 'badge badge-ativo';
        } else {
            statusBadge.textContent = 'Inativo';
            statusBadge.className = 'badge badge-inativo';
        }
    }

    async function carregarItem() {
        const debugInfo = document.getElementById('debugInfo');
        const debugText = document.getElementById('debugText');
        debugInfo.style.display = 'block';

        if (!id) {
            debugText.textContent = '❌ ID não informado na URL';
            showMessage('ID do item não informado', false);
            return;
        }

        try {
            debugText.textContent = `Carregando item ID: ${id}...`;
            console.log('Carregando item com ID:', id);

            const baseUrl = window.location.origin;
            const cacheBuster = '?_=' + new Date().getTime();
            const url = `${baseUrl}/itens/list${cacheBuster}`;

            debugText.textContent = `Conectando: ${url}`;
            console.log('URL completa:', url);

            const res = await fetch(url);
            debugText.textContent = `Resposta recebida: Status ${res.status}`;
            console.log('Status da resposta:', res.status);

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const itens = await res.json();
            debugText.textContent = `✅ Recebido ${itens.length} itens`;
            console.log('Itens recebidos:', itens);

            const item = itens.find(i => String(i.id) === String(id));
            console.log('Item encontrado:', item);

            if (item) {
                debugText.textContent = `✅ Item "${item.nome}" carregado! (Ocultar em 3s)`;

                // Guarda o item original completo
                itemOriginal = item;

                // Preenche o formulário
                document.editForm.codigo.value = item.id || '';
                document.editForm.nome.value = item.nome || '';
                ativoInput.checked = item.ativo;
                atualizarBadge();
                console.log('✅ Item carregado com sucesso!');
                console.log('Item original:', itemOriginal);

                // Oculta debug após 3 segundos
                setTimeout(() => {
                    debugInfo.style.display = 'none';
                }, 3000);
            } else {
                debugText.textContent = `❌ Item ID ${id} não encontrado`;
                showMessage('Item não encontrado', false);
            }
        } catch (err) {
            console.error('Erro detalhado:', err);
            debugText.textContent = `❌ ERRO: ${err.message}`;
            showMessage('Erro ao conectar com o servidor', false);
        }
    }

    let itemOriginal = null; // Guarda o item original para manter campos não editáveis

    document.getElementById('editForm').addEventListener('submit', async evt => {
        evt.preventDefault();
        const form = evt.target;

        if (!itemOriginal) {
            showMessage('Item não foi carregado corretamente', false);
            return;
        }

        const item = {
            id: itemOriginal.id,
            nome: form.nome.value.trim(),
            cadastradoPor: itemOriginal.cadastradoPor, // Mantém o cadastradoPor original
            ativo: ativoInput.checked,
            dataCadastro: itemOriginal.dataCadastro // Mantém data de cadastro
        };

        if (!item.nome) {
            showMessage('Nome não pode estar vazio', false);
            return;
        }

        try {
            console.log('Salvando item ID:', id, 'Dados:', item);
            const baseUrl = window.location.origin;
            const res = await fetch(`${baseUrl}/itens/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item)
            });

            if (res.ok) {
                showMessage('Item atualizado com sucesso!', true);
                const itemAtualizado = await res.json();
                itemOriginal = itemAtualizado; // Atualiza o item original
            } else {
                const errorText = await res.text();
                console.error('Erro ao atualizar:', errorText);
                showMessage('Erro ao atualizar item', false);
            }
        } catch (err) {
            console.error('Erro detalhado:', err);
            showMessage('Erro de conexão', false);
        }
    });

    // Atualiza badge quando o switch mudar
    ativoInput.addEventListener('change', atualizarBadge);

    // Botão Voltar
    document.getElementById('voltarBtn').addEventListener('click', () => {
        window.location.href = 'cadastrarItem.html';
    });

    carregarItem();
</script>
</body>
</html>